---
- name: Do bare frigate.
  hosts: frigate
  gather_facts: true
  become: true

  vars_files:
   - vars.yaml

  handlers:
  - name: daemon-reload
    ansible.builtin.systemd:
      daemon_reload: true

  - name: frigate-config-mount-enabled
    ansible.builtin.systemd:
      name: config.mount
      enabled: true

  - name: frigate-db-mount-enabled
    ansible.builtin.systemd:
      name: db.mount
      enabled: true

  - name: frigate-storage-mount-enabled
    ansible.builtin.systemd:
      name: media-frigate.mount
      enabled: true

  - name: frigate-config-mount-started
    ansible.builtin.systemd:
      name: config.mount
      state: started

  - name: frigate-db-mount-started
    ansible.builtin.systemd:
      name: db.mount
      state: started

  - name: frigate-storage-mount-started
    ansible.builtin.systemd:
      name: media-frigate.mount
      state: started

  - name: target-frigate-enabled
    ansible.builtin.systemd:
      name: frigate.target
      enabled: true

  - name: target-frigate-restarted
    ansible.builtin.systemd:
      name: frigate.target
      state: restarted

  - name: target-frigate-started
    ansible.builtin.systemd:
      name: frigate.target
      state: started

  - name: service-certsync-restarted
    ansible.builtin.systemd:
      name: certsync.service
      state: restarted

  - name: service-certsync-started
    ansible.builtin.systemd:
      name: certsync.service
      state: started

  - name: service-certsync-enabled
    ansible.builtin.systemd:
      name: certsync.service
      enabled: true

  - name: service-frigate-restarted
    ansible.builtin.systemd:
      name: frigate.service
      state: restarted

  - name: service-frigate-started
    ansible.builtin.systemd:
      name: frigate.service
      state: started

  - name: service-frigate-enabled
    ansible.builtin.systemd:
      name: frigate.service
      enabled: true

  - name: service-go2rtc-restarted
    ansible.builtin.systemd:
      name: go2rtc.service
      state: restarted

  - name: service-go2rtc-started
    ansible.builtin.systemd:
      name: go2rtc.service
      state: started

  - name: service-go2rtc-enabled
    ansible.builtin.systemd:
      name: go2rtc.service
      enabled: true

  - name: service-nginx-restarted
    ansible.builtin.systemd:
      name: nginx.service
      state: restarted

  - name: service-nginx-started
    ansible.builtin.systemd:
      name: nginx.service
      state: started

  - name: service-nginx-enabled
    ansible.builtin.systemd:
      name: nginx.service
      enabled: true

  tasks:
    - name: Fail if.
      ansible.builtin.include_tasks: fail.yaml

    - name: Do apt install.
      ansible.builtin.include_tasks: apt.yaml

#    - name: Copy files to remote server.
#      ansible.builtin.include_tasks: copy-files.yaml

#    - name: Create and install systemd services.
#      ansible.builtin.include_tasks: systemd.yaml

    - name: Set Environment variables.
      ansible.builtin.include_tasks: envs.yaml

    - name: Update systemd units.
      ansible.builtin.include_tasks: systemd.yaml

    - name: Update s6 files.
      ansible.builtin.include_tasks: s6.yaml

    - name: Update nginx.conf.
      ansible.builtin.include_tasks: nginx.yaml

    - name: Create or update frigate config file.
      ansible.builtin.include_tasks: frigate-config.yaml

#     - name: Create systemd mounts.
#       ansible.builtin.include_tasks: systemd-mounts.yaml

    - name: Disable unattended upgrades.
      ansible.builtin.include_tasks: disable-unattended-upgrades.yaml
